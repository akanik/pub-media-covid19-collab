<!doctype html>
<html lang="en-US">
  <head>
    <script src='https://code.jquery.com/jquery-1.11.0.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>COVID-19 County Tracker</title>
    
    <!-- Favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="../assets/favicons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../assets/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../assets/favicons/favicon-16x16.png">
    <link rel="manifest" href="../assets/favicons/site.webmanifest">
    <link rel="mask-icon" href="../assets/favicons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#00aba9">
    <meta name="theme-color" content="#ffffff">
    <!-- Safari, you're the worst -->
    <meta name='format-detection' content='telephone=no'>

    </script>
    <link rel="stylesheet" type="text/css" href="../Skeleton-2.0.4/css/normalize.css">
    <link rel="stylesheet" type="text/css" href="../Skeleton-2.0.4/css/skeleton.css">
    <link rel="stylesheet" type="text/css" href="../style.css">

    <style> /* set the CSS */
      body { font: 12px Arial;}
      .axis path,
      .axis line {
          fill: none;
          stroke: grey;
          stroke-width: 1;
          shape-rendering: crispEdges;
      }
    </style>

  </head>
  <body>
    <div id="main-container" class="container">
      <div id="container-top" class="row">
        <div id="banner"></div>
        <div class="lead" id="intro">
          <p>This dashboard provides a localized look at COVID-19-related cases and deaths in your county, as well as a risk assessment for your countyâ€™s population.</p>
          <div class='cta' id="update-date"></div>
        </div>
        
        <p class="cta">Use the dropdown below to display more information.</p>
        <div class="dropdown">
          <select id="county-select">
            <option>Select a county...</option>
          </select>
          <div class="down-arrow"></div>
        </div>
      </div><!-- END CONTAINER-TOP -->

      <div id="stats" class="row">

        <div id="cases-elements" class="one-half column">
          <div id="cases-text" class="text"></div>
          <div id="cases-chart" class="chart"></div>
        </div>

        <div id="deaths-elements" class="one-half column">
          <div id="deaths-text" class="text"></div>
          <div id="deaths-chart" class="chart"></div>
        </div>
      </div><!-- END STATS -->

      <div id="cnty-demo">
        <div id="cnty-pop" class="row"></div>
        <div id="cnty-age" class="row"></div>
        <div id="cnty-crd" class="row">
          <div class="img"></div>
          <div class="text"></div>
        </div>
        <div id="cnty-cvd" class="row">
          <div class="img"></div>
          <div class="text"></div>
        </div>
        <div id="cnty-dia" class="row">
          <div class="img"></div>
          <div class="text"></div>
        </div>
      </div><!-- END CNTY-DEMO -->

    </div><!-- END MAIN-CONTAINER -->
    
    <div id="data-notes">
      <h3>Disclaimer &amp; Data Sources</h3>
      <div id="data-disclaimers"></div>
      <h3>Credits</h3>
      <p>This dashboard was created by Allie Kanik at Louisville Public Media, Lisa Pickoff-White at KQED, Emily Zentner at CapRadio, and Dana Amihere at KPCC.</p>
    </div><!-- END DATA-NOTES -->
    
    <script src="st-nytimes-app.js" type="text/javascript"></script>
    <script src="https://pym.nprapps.org/pym.v1.min.js" type="text/javascript"></script>
    <script>    
      var countySelection = '';
      var countyName = '';
      var includeGA = false;
      
      var headEl = d3.select('head'); 
        
      // Add twitter metadata
      headEl.append('meta')
        .attr('property','twitter:card')
        .attr('content','summary');
      headEl.append('meta')
        .attr('property','twitter:title')
        .attr('content',meta_title);
      headEl.append('meta')
        .attr('property','twitter:site')
        .attr('content',meta_twitter);
      headEl.append('meta')
        .attr('property','twitter:url')
        .attr('content',meta_url);
      headEl.append('meta')
        .attr('property','twitter:image')
        .attr('content',meta_image);
      headEl.append('meta')
        .attr('property','twitter:description')
        .attr('content',meta_description);
      
      // Add facebook metadata
      headEl.append('meta')
        .attr('property','og:type')
        .attr('content','article');
      headEl.append('meta')
        .attr('property','og:title')
        .attr('content',meta_title);
      headEl.append('meta')
        .attr('property','og:site_name')
        .attr('content',meta_organization);
      headEl.append('meta')
        .attr('property','og:url')
        .attr('content',meta_url);
      headEl.append('meta')
        .attr('property','og:image')
        .attr('content',meta_image);
      headEl.append('meta')
        .attr('property','og:description')
        .attr('content',meta_description);
      
      // Add google structured metadata 
      var googleObj = {};  
      googleObj['@context'] = 'http://schema.org';
      googleObj['@type'] = 'NewsArticle';
      googleObj['mainEntityOfPage'] = {
        "@type": "WebPage",
        "@id": meta_url
      };
      googleObj['headline'] = meta_title;
      googleObj['image'] = {
        "@type": "ImageObject",
        "@id": meta_image
      };
      googleObj['author'] = {
        "@type": "Person",
        "@id": meta_author
      };
      googleObj['publisher'] = {
        "@type": "Organization",
        "name": meta_organization,
        "logo": {
          "@type": "ImageObject",
          "url": meta_org_logo,
          "width": 899,
          "height": 126
        }
      };
      googleObj['description'] = meta_description;
      headEl.append('script')
        .attr('type','application/ld+json')
        .text(JSON.stringify(googleObj));    
        
      
      // Add data source
      var addDataSource = d3.select('#data-disclaimers')
        .html(data_sources); 
        
      var addBanner = d3.select('#container-top #banner')
        .html('<h1>'+stateName+' COVID-19 Tracker</h1>');
                

      var dropdown = d3.select('#county-select');
      var stateStats = d3.select('#state-stats').append('p');

      var formatComma = d3.format(","),
          formatDecimal = d3.format(".1f"),
          formatNoDecimal = d3.format(".0f"),
          formatDecimalComma = d3.format(",.2f"),
          formatSuffix = d3.format("s"),
          formatSuffixDecimal1 = d3.format(".1s"),
          formatSuffixDecimal2 = d3.format(".2s"),
          formatMoney = function(d) { return "$" + formatDecimalComma(d); },
          formatPercent = d3.format(",.2%");

      // Parse the date / time
      var	parseDate = d3.time.format(dateFormat).parse;



      //ADD COUNTY DATA
      d3.csv("../assets/data/national-cnty-covid19-risk-analysis.csv", function(fips_error, fips_data) {
        
        if (fips_error) {
          return console.warn(fips_error);
        }
        
        var stateDemo = fips_data.filter( function(d){
              return d['cnty_name'] == stateName
        });
        var stateFips = stateDemo[0]['cnty_fips'];
        var statePop = stateDemo[0]['population'];
        
        fips_data.forEach(function(d) {
          //d.date = parseDate(d.date);
          d.crd_rate = formatNoDecimal(d.crd_rate);
          d.cvd_rate = formatNoDecimal(d.cvd_rate);
          d.diabetes_rate = formatNoDecimal(d.diabetes_rate);
          d.population = d.population.replace(/,/g, '');
          d.cnty_name = d.cnty_name.replace(', '+stateName,'');
        });

        //ADD CASE DATA
        d3.csv(casesFile, function(case_error, case_data) {
          if (case_error) {
            return console.warn(case_error);
          }

          case_data.forEach(function(d) {
            //d.date = parseDate(d.date);
            d.cases = d.cases.replace(/,/g, '');
          });
          

          //BEGIN CHART STUFF
          var elWidth = document.getElementById("cases-chart").offsetWidth;

          // Set the dimensions of the canvas / graph
          var	margin = {top: 30, right: 20, bottom: 30, left: 50};
          //var width,height;
          var width = elWidth - margin.left - margin.right;
          var height = 270 - margin.top - margin.bottom;

          // Set the case ranges
          var	xCases = d3.time.scale().range([0, width]);
          var	yCases = d3.scale.linear().range([height, 0]);

          // Define the case axes
          var	xCaseAxis = d3.svg.axis().scale(xCases)
          	.orient("bottom").ticks(d3.time.sunday).tickSize(8, 0);
          var	yCaseAxis = d3.svg.axis().scale(yCases)
          	.orient("left").ticks(5);

          // Adds the svg cases
          var	svgCases = d3.select("#cases-chart")
          	.append("svg")
          		.attr("width", width + margin.left + margin.right)
          		.attr("height", height + margin.top + margin.bottom)
          	.append("g")
          		.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

          // Define the case line
          var caseValueline = d3.svg.line()
            	.x(function(d) { return xCases(d.date); })
            	.y(function(d) { return yCases(parseFloat(d.cases)); });


          // Set the death ranges
          var	xDeaths = d3.time.scale().range([0, width]);
          var	yDeaths = d3.scale.linear().range([height, 0]);

          // Define the death axes
          var	xDeathAxis = d3.svg.axis().scale(xDeaths)
          	.orient("bottom").ticks(d3.time.sunday).tickSize(8, 0);
          var	yDeathAxis = d3.svg.axis().scale(yDeaths)
          	.orient("left").ticks(5);

          // Adds the svg cases
          var	svgDeaths = d3.select("#deaths-chart")
          	.append("svg")
          		.attr("width", width + margin.left + margin.right)
          		.attr("height", height + margin.top + margin.bottom)
          	.append("g")
          		.attr("transform", "translate(" + margin.left + "," + margin.top + ")");


          // Define deaths line
          var	deathValueline = d3.svg.line()
          	.x(function(d) { return xDeaths(d.date); })
          	.y(function(d) { return yDeaths(parseFloat(d.deaths)); });


          ////////////DATA FORMATING FUNCTIONS/////////////////

          function formatCaseData(data){
            data = data.filter(function(d){
              return d['state'] == stateName
            });
            var stateDataByDate = d3.nest()
              .key(function(d) {return d.date;})
              .rollup(function(d) {
                return {
                    cases: d3.sum(d, function(e) { return parseFloat(e.cases); }),
                    deaths: d3.sum(d, function(e) { return parseFloat(e.deaths); })
                };
              })
              .entries(data);

            var caseDateLookup = {};
            for(i=0;i<stateDataByDate.length;i++){
              dict = {}
              dict['date'] = parseDate(stateDataByDate[i].key);
              dict['cases'] = stateDataByDate[i].values.cases;
              dict['deaths'] = stateDataByDate[i].values.deaths;
              caseDateLookup[i] = dict;
            }
            return Object.values(caseDateLookup);
          }// END formatCaseData

          function updatePopText(region_data){

            var cntyName = region_data['cnty_name'];
            var pop65plus = region_data['perc_65plus'];

            var crdRate = region_data['crd_rate']+' out of 100,000';
            var crdQ = region_data['us_crd_q'];

            var cvdRate = region_data['cvd_rate']+' out of 100,000';;
            var cvdQ = region_data['us_cvd_q'];

            var diaRate = region_data['diabetes_rate'];
            var diaQ = region_data['us_diabetes_q'];

            var quarHR = {
              "1":"This county's rate is <span class='q1'>better than 75%</span> of all U.S. county rates.",
              "2":"This county's rate is <span class='q2'>better than 50%</span> of all U.S. county rates.",
              "3":"This county's rate is <span class='q3'>worse than 50%</span> of all U.S. county rates.",
              "4":"This county's rate is <span class='q4'>worse than 75%</span> of all U.S. county rates."
            };


            var popText = "Experts say that some groups are more at risk if they contract COVID-19, "+
                          "for instance, seniors or people who suffer from diabetes, chronic respiratory"+
                          " disease or cardiovascular disease. Hereâ€™s a breakdown of how many people in "+
                          cntyName + " are part of these vulnerable groups.";

            var ageText = "<p><strong>"+pop65plus+"%</strong> of "+cntyName+"&#39;s residents are age 65 or older.</p>";

            var crdText = "<p>"+cntyName + " has a chronic respiratory disease death rate of <strong>"+crdRate+"</strong>. "+quarHR[crdQ]+
                          "</p><p>People who suffer from chronic respiratory disease are more vulnerable to a serious"+
                          " COVID-19 case, because the coronavirus can inflame the lungs.</p>";

            var cvdText = "<p>"+cntyName + " has a cardiovascular disease death rate of <strong>"+cvdRate+"</strong>. "+quarHR[cvdQ]+
                          "</p><p>The novel coronavirus especially threatens people with cardiovascular disease. "+
                          "In patients whose heart is made more vulnerable by pre-existing conditions, "+
                          "COVID-19 causes complications like embolisms and irregular heartbeats, and that "+
                          "raises a patientâ€™s risk of death.</p>";

            var diaText = '<p><strong>'+diaRate+"%</strong> of adults over age 20</strong> in "+cntyName+" have diabetes. "+quarHR[diaQ]+
                          "</p><p>COVID-19 threatens people with diabetes, whose blood sugar isn't stable, because this"+
                          " pre-existing condition makes their ability to fight off infection unstable too. "+
                          "Unchecked, the virus can cause complications leading to coma or death.</p>";

            //// Add text to case text block
            //var totalCases = d3.max(caseDateLookup, function(d) {return d.cases;});
            //var totalCaseText = 'There have been '+ formatComma(totalCases) +' confirmed cases of COVID-19 in <strong>'+
            //                    region_name +'</strong>.';
            var casesText = d3.select('#cnty-pop')
              .attr('class','stat-row')
              .html('<h2>Vulnerable populations in '+ cntyName + '</h2>')
              .append('p')
              .html(popText);

            var ageText = d3.select('#cnty-age')
              .attr('class','stat-row')
              .html(ageText)


            var crdText = d3.select('#cnty-crd')
              .attr('class','stat-row')
              .select('.text')
                .html('<h2>Chronic Respiratory Disease</h2>'+crdText)    

            var crdImg = d3.select('#cnty-crd .img')
              .html('')
              .append('img')
                .attr('src','../assets/quartiles/crd-q'+crdQ+'.png')
                .attr('width',175)
                .attr('alt','quartile chart');


            var cvdText = d3.select('#cnty-cvd')
              .attr('class','stat-row')
              .select('.text')
                .html('<h2>Cardiovascular Disease</h2>'+cvdText)

            var cvdImg = d3.select('#cnty-cvd .img')
              .html('')
              .append('img')
                .attr('src','../assets/quartiles/cvd-q'+cvdQ+'.png')
                .attr('width',175)
                .attr('alt','quartile chart');


            var diaText = d3.select('#cnty-dia')
              .attr('class','stat-row')
              .select('.text')
                .html('<h2>Diabetes</h2>'+diaText)

            var diaImg = d3.select('#cnty-dia .img')
              .html('')
              .append('img')
                .attr('src','../assets/quartiles/dia-q'+diaQ+'.png')
                .attr('width',175)
                .attr('alt','quartile chart');
          }// END updatePopText
          
          var getDaysArray = function(start, end) {
            end = end.setDate(end.getDate()+1);
            for(var arr=[],dt=new Date(start); dt<=end; dt.setDate(dt.getDate()+1)){
                arr.push(new Date(dt));
            }
            return arr;
          };
          

          function updateChartText(caseDateLookup,region_name,pop){    
            var minDate = d3.min(caseDateLookup, function(d) {return d.date;});
            var maxDate = d3.max(caseDateLookup, function(d) {return d.date;});
            var days = getDaysArray(new Date(minDate),new Date(maxDate));
            
            var mostRecentRecord = caseDateLookup.filter(function(d) {
                return d.date == d3.max(caseDateLookup, function(d) {return d.date;})
            });
            
            if((mostRecentRecord.length == 0)|| isNaN(mostRecentRecord[0]['cases']) ){
              var totalCaseText = 'There have been <strong>no reported cases</strong> of COVID-19 in '+
                                region_name +'. The population of this region is '+ formatComma(pop) + '.';
              var casesText = d3.select('#cases-text')
                .html('<h2>Positive cases</h2>')
                .append('p')
                .html(totalCaseText);
                
            }else{
              var totalCases = mostRecentRecord[0]['cases'];
              var perCapita = (totalCases/pop)*100000//per capital per 100,000
              var totalCaseText = 'There have been <strong>'+ formatComma(totalCases) +' cases</strong> of COVID-19 in '+
                                  region_name +'. The population of this region is '+ formatComma(pop) + '. That&#39;s '+
                                   formatNoDecimal(perCapita) + ' cases per 100,000 people.';
              var casesText = d3.select('#cases-text')
                .html('<h2>Positive cases</h2>')
                .append('p')
                .html(totalCaseText);
            }
            
            if((mostRecentRecord.length == 0) || isNaN(mostRecentRecord[0]['deaths'])){  
              var totalDeathText = 'There have been <strong>no reported deaths</strong> related to COVID-19 in '+
                                region_name + '.';
              var deathText = d3.select('#deaths-text')
                .html('<h2>Deaths</h2>')
                .append('p')
                .html(totalDeathText);
            }else{
              var totalDeaths = mostRecentRecord[0]['deaths'];
              // Add text to death text block
              var totalDeathText = 'There have been <strong>'+ formatComma(totalDeaths) +
                                  ' reported deaths</strong> related to COVID-19 in '+ region_name + '.';
              var deathText = d3.select('#deaths-text')
                .html('<h2>Deaths</h2>')
                .append('p')
                .html(totalDeathText);
            }
            
          }// END updateChartText

          function updateCharts(caseDateLookup,region_name,pop) {

            updateChartText(caseDateLookup,region_name,pop);
            
            // First update the cases y-axis domain to match data
            yCases.domain([0, d3.max(caseDateLookup, function(d) {return d.cases;})]);

            svgCases.select(".line")   // change the line
              .transition()
              .duration(750)
              .attr("d", caseValueline(caseDateLookup));

            svgCases.select(".y.axis") // change the y axis
              .transition()
              .duration(750)
              .call(yCaseAxis);

            // First update the deaths y-axis domain to match data
            yDeaths.domain([0, d3.max(caseDateLookup, function(d) {return d.deaths;})]);

            svgDeaths.select(".line")   // change the line
              .transition()
              .duration(750)
              .attr("d", deathValueline(caseDateLookup));

            svgDeaths.select(".y.axis") // change the y axis
              .transition()
              .duration(750)
              .call(yDeathAxis);
              
            pymChild.sendHeight();
          };// END updateCharts

          function createCharts(caseDateLookup,region_name,pop){
            
            // Add update date from either the app.js file or the data
            var maxDate;
            if(lastUpdated !== ''){
              maxDate = lastUpdated;
            }else{
              maxDate = d3.max(caseDateLookup, function(d) {return d.date;});
              maxDate = maxDate.toLocaleDateString("en-US");
            }
            var updateDate = d3.select('#update-date')
              .html('Data last updated '+maxDate+'.');

            updateChartText(caseDateLookup,region_name,pop);

          	// Scale the range of the case data
          	xCases.domain(d3.extent(caseDateLookup, function(d) { return d.date; }));
          	yCases.domain([0, d3.max(caseDateLookup, function(d) {return d.cases;})]);

          	// Add the valueline path to svgCases.
          	svgCases.append("path")
          	  .datum(caseDateLookup)
          		.attr("class", "line")
          		.attr("stroke", "#8C8C8C")
          		.attr("stroke-width", 2)
          		//.attr("fill", "#cccccc")
          		.attr("fill", "None")
          		.attr("d", caseValueline(caseDateLookup));

          	// Add the case X Axis
          	svgCases.append("g")
          		.attr("class", "x axis")
          		.attr("transform", "translate(0," + height + ")")
          		.call(xCaseAxis);

          	// Add the case Y Axis
          	svgCases.append("g")
          		.attr("class", "y axis")
          		.call(yCaseAxis);


            // Scale the range of the death data
          	xDeaths.domain(d3.extent(caseDateLookup, function(d) { return d.date; }));
          	yDeaths.domain([0, d3.max(caseDateLookup, function(d) {return d.deaths;})]);

            // Add the valueline path to svgDeaths.
          	svgDeaths.append("path")
          	  .datum(caseDateLookup)
          		.attr("class", "line")
          		.attr("stroke", "#CC3333")
          		.attr("stroke-width", 2)
          		//.attr("fill", "#FD6565")
          		.attr("fill", "None")
          		.attr("d", deathValueline(caseDateLookup));

          	// Add the death X Axis
          	svgDeaths.append("g")
          		.attr("class", "x axis")
          		.attr("transform", "translate(0," + height + ")")
          		.call(xDeathAxis);

          	// Add the death Y Axis
          	svgDeaths.append("g")
          		.attr("class", "y axis")
          		.call(yDeathAxis);
          }//END createCharts


          function filterCntyPop(cntyFips){
            var cntyFilter = cntyData.filter( function(d){
              return d['cnty_fips'] == cntyFips
            });
            return cntyFilter;
          }

          function filterCntyCases(cnty_fips){
            var cntyFilter = case_data.filter( function(d){
              return d['fips'] == cnty_fips
            });
            return cntyFilter;
          }

          function filterStateCounties(stateFips){
            var stateFilter = fips_data.filter( function(d){
              return d['state_fips'] == stateFips
            });
            return stateFilter;
          }

          //COUNTY STUFF
          var cntyData = filterStateCounties(stateFips);
          cntyData.unshift({ cnty_name: 'Select a county..', cnty_fips: 'default'});
          dropdown.selectAll('option')
              .data(cntyData)
            .enter().append('option')
              .attr('value', function(d) {
                return d.cnty_fips;
              })
              .text(function(d) {
                  return d.cnty_name;
              });
            dropdown.on('change',function(){
              dataLevel = 'county';
              countySelection = d3.select(this).property('value');
              countyName = d3.select('#county-select option:checked').text();

              var cntyPopData = filterCntyPop(countySelection);
              var cntyPop = cntyPopData[0]['population'];
              console.log(cntyPop);
              updatePopText(cntyPopData[0]);

              var filtered_cases = filterCntyCases(countySelection);
              caseDateLookup = formatCaseData(filtered_cases);
              updateCharts(caseDateLookup,countyName,cntyPop);
            });

          var caseDateLookup = formatCaseData(case_data);
          var pymChild = new pym.Child({ renderCallback: createCharts(caseDateLookup,stateName,statePop) });
        });
      });

    </script>
    <!-- Google Analytics -->
    <script>
      if(includeGA == false){
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
        ga('send', 'pageview');
      }else{
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
        ga('create', ga_id, 'auto');
        ga('send', 'pageview');
      }
    </script>
  <!-- End Google Analytics -->
  </body>
</html>
