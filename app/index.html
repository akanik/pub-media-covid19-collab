<!doctype html>
<html lang="en-US">
  <head>
    <script src='https://code.jquery.com/jquery-1.11.0.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>COVID-19 County Tracker</title>

    <!-- Favicon -->
    <link rel="apple-touch-icon" sizes="152x152" href="https://ohiovalleyresource.org/wp-content/themes/wfpl-v2/res/img/apple-touch-icon-152-precomposed.png" />
    <link rel="icon" sizes="120x120" href="https://ohiovalleyresource.org/wp-content/themes/wfpl-v2/res/img/apple-touch-icon-120-precomposed.png" />
    <link rel="icon" sizes="76x76" href="https://ohiovalleyresource.org/wp-content/themes/wfpl-v2/res/img/apple-touch-icon-76-precomposed.png" />
    <!-- Safari, you're the worst -->
    <meta name='format-detection' content='telephone=no'>
    
    
    <!-- BEGIN TWITTER SUMMARY CARD -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Interactive: Coal & Gas Extraction Near WV Water Sources">
    <meta name="twitter:site" content="@OVReSRC">
    <meta name="twitter:url" content="https://local.wfpl.org/ovr/water-hazards/index.html">
    <meta name="twitter:image" content="https://local.wfpl.org/ovr/water-hazards/assets/ovr-water-hazards-cover.png">
    <meta name="twitter:description" content="EXPLORE: The Ohio Valley ReSource used data on protected water areas to build this tool showing some of the coal mines and gas wells within the watersheds providing West Virginians drinking water.">
    
    <!-- Social sharing meta -->
    <meta property="og:type" content="article">
    <meta property="og:title" content="Interactive: Coal & Gas Extraction Near WV Water Sources">
    <meta property="og:site_name" content="Ohio Valley ReSource">
    <meta property="og:url" content="https://local.wfpl.org/ovr/water-hazards/index.html">
    <meta property="og:image" content="https://local.wfpl.org/ovr/water-hazards/assets/ovr-water-hazards-cover.png">
    <meta property="og:description" content="EXPLORE: The Ohio Valley ReSource used data on protected water areas to build this tool showing some of the coal mines and gas wells within the watersheds providing West Virginians drinking water.">
    
    <!-- Google structured data -->
    <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "NewsArticle",
      "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://local.wfpl.org/ovr/water-hazards/"
      },
      "headline": "Interactive: Coal & Gas Extraction Near WV Water Sources",
      "image": {
        "@type": "ImageObject",
        "url": "https://local.wfpl.org/ovr/water-hazards/assets/ovr-water-hazards-cover.png"
      },
      "author": {
        "@type": "Person",
        "name": "NPR Staff"
      },
      "publisher": {
        "@type": "Organization",
        "name": "NPR",
        "logo": {
          "@type": "ImageObject",
          "url": "https://local.wfpl.org/ovr/water-hazards/assets/logo.png",
          "width": 891,
          "height": 296
        }
      },
      "description": "EXPLORE: The Ohio Valley ReSource used data on protected water areas to build this tool showing some of the coal mines and gas wells within the watersheds providing West Virginians drinking water."
    }
    </script>
    <link rel="stylesheet" type="text/css" href="Skeleton-2.0.4/css/normalize.css">
    <link rel="stylesheet" type="text/css" href="Skeleton-2.0.4/css/skeleton.css">
    <link rel="stylesheet" type="text/css" href="style.css">
    
    <style> /* set the CSS */
      body { font: 12px Arial;}
      path { 
          stroke: steelblue;
          stroke-width: 2;
          fill: none;
      }
      .axis path,
      .axis line {
          fill: none;
          stroke: grey;
          stroke-width: 1;
          shape-rendering: crispEdges;
      }
    </style>
    
  </head>
  <body>
    <div id="container" class="container">
      <div id="container-top" class="row">
        <h1>California COVID-19 Case Tracker</h1>
        <div class="lead" id="intro">
          <p>This dashboard provides a localized look at confirmed cases of and deaths related to COVID-19 in your county, as well as a risk assessment for your countyâ€™s population. Select your state and county below to see your local numbers.</p>
        </div>
        
        <select id="county-select" class="row">
          <option>Select a county...</option>
        </select>        
  
      </div><!-- END CONTAINER-TOP -->
      
      <div id="stats" class="row">
        
        <div id="cnty-cases" class="stat-row row">
          <div id="cases-chart" class="chart one-half column">
            <!--<img src="assets/chart-example.png" alt="county covid-19 case count overtime" />-->
          </div>
          <div id="cases-text" class="text one-half column">
            <h5>Positive cases</strong></h5>
          </div>
        </div>
        
        <div id="cnty-deaths" class="stat-row row">
          <div id="deaths-chart" class="chart one-half column">
            <!--<img src="assets/chart-example.png" alt="county covid-19 case count overtime" />-->
          </div>
          <div id="deaths-text" class="text one-half column">
            <h5>Deaths</strong></h5>
          </div>
        </div>
        <div id="cnty-demo" class="stat-row row">
          <div class="text">
            <h5>County vulnerable population information</strong></h5>
            <p><strong>Adair County, Kentucky</strong> has a population of <strong>19,241 people</strong>. <strong>21.9%</strong> of them are 62 years or older. They have a cardiovascular disease death rate of <strong>341.77 per 100,000</strong> people and a chronic respiratory disease death rate of <strong>65.02 per 100,000</strong> people. <strong>15.69%</strong> of the population 20 years and older have diabetes.</p>
            <p><em>*Cardiovascular disease, chronic respiratory disease and diabetes are all known complications to covid-19.</em></p>
          </div>
        </div>
        
      </div><!-- END STATS -->
      
      <div id="data-notes" class="row">
        <div id="data-sources">
          <p>Sources: xxxxxx; xxxxxx; xxxxxx</p>
        </div>
        <div id="data-disclaimers">
          <p>CB's Nuts Peanut Butter is produced in Washington State from peanuts grown in Texas. Aside from using the best peanuts in the world, our slow barrel roasting process is what sets us apart and gives our PB its rich roasted taste that's unlike any other brand on the market. Its also this roasting technique, along with our Creamunchy grind that limits annoying oil separation in the jar.</p>
        </div>
      </div><!-- END DATA-NOTES -->
    </div>
    
    <script>
      var cases_file = 'assets/data/2020-03-25-California-export.csv';
      var state_fips = '06';
      var state_name = 'California';
      
      var include_state_testing = false;
      
      var data_level = 'state';
      var county_selection = '';
      var county_name = '';
      
      var dropdown = d3.select('#county-select');
      var stateStats = d3.select('#state-stats').append('p');
      
      
      
      //ADD COUNTY DATA
      d3.csv("assets/data/national-cnty-covid19-risk-analysis.csv", function(fips_error, fips_data) {
        if (fips_error) {
          return console.warn(fips_error);
        }
        //ADD CASE DATA
        d3.csv(cases_file, function(case_error, case_data) {
          if (case_error) {
            return console.warn(case_error);
          }   
                      
          //BEGIN CHART STUFF
          var elWidth = document.getElementById("cases-chart").offsetWidth;
          
          // Set the dimensions of the canvas / graph
          var	margin = {top: 30, right: 20, bottom: 30, left: 50},
          	width = elWidth - margin.left - margin.right,
          	height = 270 - margin.top - margin.bottom;
           
          // Parse the date / time
          var	parseDate = d3.time.format("%Y-%m-%d").parse;
           
          // Set the case ranges
          var	xCases = d3.time.scale().range([0, width]);
          var	yCases = d3.scale.linear().range([height, 0]);
          
          // Define the case axes
          var	xCaseAxis = d3.svg.axis().scale(xCases)
          	.orient("bottom").ticks(5);
          var	yCaseAxis = d3.svg.axis().scale(yCases)
          	.orient("left").ticks(5);
          	
          // Adds the svg cases
          var	svgCases = d3.select("#cases-chart")
          	.append("svg")
          		.attr("width", width + margin.left + margin.right)
          		.attr("height", height + margin.top + margin.bottom)
          	.append("g")
          		.attr("transform", "translate(" + margin.left + "," + margin.top + ")");
          		
          var yCasesAxisForUpdate = svgCases.append("g")
            .attr("class", "y axis")
            .call(yCaseAxis);
            
          // Define the case line
          var caseValueline = d3.svg.line()
            	.x(function(d) { return xCases(d.date); })
            	.y(function(d) { return yCases(parseFloat(d.cases)); });
          		
    
          // Set the death ranges
          var	xDeaths = d3.time.scale().range([0, width]);
          var	yDeaths = d3.scale.linear().range([height, 0]);
          
          // Define the death axes
          var	xDeathAxis = d3.svg.axis().scale(xDeaths)
          	.orient("bottom").ticks(5);
          var	yDeathAxis = d3.svg.axis().scale(yDeaths)
          	.orient("left").ticks(5);
          		
          // Adds the svg cases
          var	svgDeaths = d3.select("#deaths-chart")
          	.append("svg")
          		.attr("width", width + margin.left + margin.right)
          		.attr("height", height + margin.top + margin.bottom)
          	.append("g")
          		.attr("transform", "translate(" + margin.left + "," + margin.top + ")");
          		
          var yDeathAxisForUpdate = svgDeaths.append("g")
            .attr("class", "y axis")
            .call(yDeathAxis);
            
          // Define deaths line
          var	deathValueline = d3.svg.line()
          	.x(function(d) { return xDeaths(d.date); })
          	.y(function(d) { return yDeaths(parseFloat(d.deaths)); });
          		
            
          ////////////DATA FORMATING FUNCTIONS///////////////// 	 
          
          function formatCaseData(data){
            var stateDataByDate = d3.nest()
              .key(function(d) {return d.date;})
              .rollup(function(d) {
                return {
                    cases: d3.sum(d, function(e) { return parseFloat(e.cases); }),
                    deaths: d3.sum(d, function(e) { return parseFloat(e.deaths); })
                };
              })
              .entries(data);
            
            var caseDateLookup = {};
            for(i=0;i<stateDataByDate.length;i++){
              dict = {}
              dict['date'] = parseDate(stateDataByDate[i].key);
              dict['cases'] = stateDataByDate[i].values.cases;
              dict['deaths'] = stateDataByDate[i].values.deaths;
              caseDateLookup[i] = dict;
            }
            return Object.values(caseDateLookup);
          }
          
          function updateText(caseDateLookup,region_name){
            // Add text to case text block
            var totalCases = d3.max(caseDateLookup, function(d) {return d.cases;});
            var totalCaseText = 'There have been '+totalCases+' confirmed cases of COVID-19 in '+region_name+'.';
            var casesText = d3.select('#cases-text')
              .html('<h5>Positive cases</strong></h5>')
              .append('p')
              .append("text")
              .text(totalCaseText);
              
            // Add text to death text block
            var totalDeaths = d3.max(caseDateLookup, function(d) {return d.deaths;});
            var totalDeathText = 'There have been '+totalDeaths+' reported deaths related to COVID-19 in '+region_name+'.';
            var deathText = d3.select('#deaths-text')
              .html('<h5>Deaths</strong></h5>')
              .append('p')
              .append("text")
              .text(totalDeathText);
          }
          
          function updateCharts(caseDateLookup,region_name) {
            
            updateText(caseDateLookup,region_name);
            
            // First update the cases y-axis domain to match data
            yCases.domain([0, d3.max(caseDateLookup, function(d) {return d.cases;})]);
            yCasesAxisForUpdate.call(yCases);

            svgCases.select(".line")   // change the line
              .transition()
              .duration(750)
              .attr("d", caseValueline(caseDateLookup));
              
            svgCases.select(".y.axis") // change the y axis
              .transition()
              .duration(750)
              .call(yCaseAxis);
              

              
            // First update the deaths y-axis domain to match data
            yDeaths.domain([0, d3.max(caseDateLookup, function(d) {return d.deaths;})]);
            yDeathAxisForUpdate.call(yDeaths);

            svgDeaths.select(".line")   // change the line
              .transition()
              .duration(750)
              .attr("d", deathValueline(caseDateLookup));
              
            svgDeaths.select(".y.axis") // change the y axis
              .transition()
              .duration(750)
              .call(yDeathAxis);
          };
          
          function createCharts(caseDateLookup,region_name){
            
            updateText(caseDateLookup,region_name);         
                        
          	// Scale the range of the case data
          	xCases.domain(d3.extent(caseDateLookup, function(d) { return d.date; }));
          	yCases.domain([0, d3.max(caseDateLookup, function(d) {return d.cases;})]);
          	       
          	// Add the valueline path to svgCases.          	
          	svgCases.append("path")
          	  .datum(caseDateLookup)
          		.attr("class", "line")
          		.attr("d", caseValueline(caseDateLookup));
           
          	// Add the case X Axis
          	svgCases.append("g")		
          		.attr("class", "x axis")
          		.attr("transform", "translate(0," + height + ")")
          		.call(xCaseAxis);
           
          	// Add the case Y Axis
          	svgCases.append("g")		
          		.attr("class", "y axis")
          		.call(yCaseAxis);
            
            	
            // Scale the range of the death data
          	xDeaths.domain(d3.extent(caseDateLookup, function(d) { return d.date; }));
          	yDeaths.domain([0, d3.max(caseDateLookup, function(d) {return d.deaths;})]);
          	
            // Add the valueline path to svgDeaths.
          	svgDeaths.append("path")	
          	  .datum(caseDateLookup)
          		.attr("class", "line")
          		.attr("d", deathValueline(caseDateLookup));
           
          	// Add the death X Axis
          	svgDeaths.append("g")		
          		.attr("class", "x axis")
          		.attr("transform", "translate(0," + height + ")")
          		.call(xDeathAxis);
           
          	// Add the death Y Axis
          	svgDeaths.append("g")		
          		.attr("class", "y axis")
          		.call(yDeathAxis);
          }//END getSelectionTotals
          
          
          function filterCntyData(cnty_fips){
            var cntyFilter = case_data.filter( function(d){
              return d['fips'] == cnty_fips
            });
            return cntyFilter;
          }
          
          function filterStateData(state_fips){
            var stateFilter = fips_data.filter( function(d){
              return d['state_fips'] == state_fips
            });
            return stateFilter;
          }
          
          //COUNTY STUFF
          var cnty_data = filterStateData(state_fips);
          console.log(cnty_data);
          dropdown.selectAll('option')
              .data(cnty_data)
            .enter().append('option')
              .attr('value', function(d) {
                return d.cnty_fips;
              })
              .text(function(d) {
                  return d.cnty_name;
              });
            dropdown.on('change',function(){
              data_level = 'county';
              county_selection = d3.select(this).property('value');
              county_name = d3.select('#county-select option:checked').text();
              
              var newData = filterCntyData(county_selection);
              caseDateLookup = formatCaseData(newData);
              updateCharts(caseDateLookup,county_name);
            });
            
          var caseDateLookup = formatCaseData(case_data);
          createCharts(caseDateLookup,state_name);
          
        });
      });
      
    </script>
    <script>
    //  window.onload=function(){
    //    d3.json("assets/data/cnty-fips.json", function(error, data) {
    //      console.log(data);
    //      if (error) {
    //          return console.warn(error);
    //      }
    //      d3.select("select")
    //        .selectAll("option")
    //        .data(data)
    //        .enter()
    //        .append("option")
    //        .attr('value', function(d) {
    //          return d.values();
    //          //console.log(d);
    //        })
    //        .text(function(d) {
    //            return d.keys();
    //        });
    //    });
    //  }//]]>
        
        
        
        
        
      //  var stateSelect = d3.select("#state-select");
      //  
      //  var stateCounties = cnty_fips['06'];        
      //
      //  //we have select all options tags from inside select tag (which there are 0 atm)
      //  //and assigned data as to be the base of modelling that selection.
      //  var stateOptions = stateSelect.selectAll('option')
      //    .data(stateCounties);
      //    
      //  console.log(stateOptions);
      //
      //  //d3 sees we have less elements (0) than the data (2), so we are tasked to create
      //  //these missing inside the `options.enter` pseudo selection.
      //  //if we had some elements from before, they would be reused, and we could access their
      //  //selection with just `options`
      //  stateOptions.enter()
      //    .append('option')
      //    .attr('value', function(d) {
      //      return d.values();
      //      //console.log(d);
      //    })
      //    .text(function(d) {
      //      return d.values();
      //      //console.log(d);
      //    });
      //  });
      //
      //d3.select("#state-select")
      //  .append("select")
      //  .append("option")
      //  .attr("value", "---")
      //  .text("---");
      
      
      
      //const pymChild = new pym.Child({ polling: 100 });
      //  
      ////////////// THIS IS ALL AUTO GEOLOCATOR CODE. WE CAN'T USE IT UNTIL WE UPGRADE SERVER TO HTTPS
      //function getLocation() {
      //    if (navigator.geolocation) {
      //        navigator.geolocation.getCurrentPosition(autoGeo);
      //    } else {
      //        console.log("Geolocation is not supported by this browser.");
      //    }
      //}
      //
      //function autoGeo(position){
      //  var foundLat = position.coords.latitude;
      //  var foundLng = position.coords.longitude;
      //  var point = [foundLat, foundLng];
      //  var inKY = findState(point);
      //  
      //  if(inKY == 1){
      //    if(marker){
      //      map.removeLayer(marker); 
      //    }
      //    marker = L.marker([foundLat, foundLng]).addTo(map);
      //    map.flyTo(new L.LatLng(foundLat, foundLng), 11);
      //    findDistrict(foundLat,foundLng)
      //  }else{
      //    houseDIV.innerHTML = "<p><em>Looks like you're not in Kentucky</em></p>";
      //    metroDIV.innerHTML = "<p><em>Looks like you're not in Jefferson County</em></p>";
      //    houseContestDIV.innerHTML = '';
      //    metroContestDIV.innerHTML = '';
      //  }
      //}
      //  
      //function findState(point){
      //  const addURL = 'http://dev.virtualearth.net/REST/v1/Locations/' + point + '?o=json&key=' + BING_KEY;
      //  
      //  $.ajax({
      //    url: addURL,
      //    type: 'GET',
      //    success: function(result){
      //      var state = result['resourceSets'][0]['resources'][0]['address']['adminDistrict'];
      //      
      //      geoResultsDIV.innerHTML = 'Showing results for ' + result['resourceSets'][0]['resources'][0]['address']['formattedAddress'];
      //      
      //      if(state != 'KY'){
      //        return 0;
      //      }else{
      //        return 1;
      //      }            
      //    },
      //    error: function(error){
      //      console.log(`Error ${error}`)
      //    }
      //  })
      //}
        ////////////// END AUTO GEOLOCATON
    </script>
    
    <script src="app.js" async></script>
    <!-- Google Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
    
    //If we're embedding, we don't want to make this a new session so keep this commented out
    //ga('create', 'UA-5828686-4', 'auto');
    //
    ga('send', 'pageview');
    </script>
    <!-- End Google Analytics -->
  </body>
</html>
